name: Build OpenWrt
'on':
  workflow_dispatch:
    inputs:
      openwrt_version:
        default: 24.10.5
        description: 'Specify OpenWrt version (e.g., 23.05.0 or 24.10.0-rc4)'
        required: false
env:
  REPO_URL: 'https://github.com/openwrt/openwrt.git'
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: false
  TZ: Europe/Kiev
  KEEP_LATEST_RELEASES: 3
  DELETE_ONLY_PRE_RELEASES: false
jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout workflow repository
        uses: actions/checkout@v4
      - name: Determine OpenWrt version
        id: version
        run: >
          if [ -n "${{ github.event.inputs.openwrt_version }}" ]; then
          RAW_VERSION="${{ github.event.inputs.openwrt_version }}" else
          RAW_VERSION=$(curl -fsSL
          https://api.github.com/repos/openwrt/openwrt/releases | \ jq -r '[.[]
          | select(.prerelease==false)][0].tag_name') fi
          VERSION="${RAW_VERSION#v}" VERSION="v$VERSION" echo "Using OpenWrt
          tag: $VERSION" echo "REPO_BRANCH=$VERSION" >> "$GITHUB_ENV"
      - name: Initialize environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo timedatectl set-timezone "$TZ"
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk gcc-multilib \
            gettext git libncurses-dev libssl-dev python3-setuptools \
            rsync unzip zlib1g-dev file wget curl jq
      - name: Clean up disk space
        run: >
          sudo apt-get autoremove -y sudo apt-get clean sudo rm -rf
          /var/lib/apt/lists/* sudo rm -rf /usr/share/dotnet
          /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL df -h
      - name: Clone OpenWrt source
        run: |
          git clone "$REPO_URL" -b "$REPO_BRANCH" --depth 1 openwrt
          test -d openwrt
      - name: Load custom feeds
        run: |
          if [ -f "$GITHUB_WORKSPACE/$FEEDS_CONF" ]; then
            mv "$GITHUB_WORKSPACE/$FEEDS_CONF" openwrt/feeds.conf.default
          fi
          if [ -f "$GITHUB_WORKSPACE/$DIY_P1_SH" ]; then
            chmod +x "$GITHUB_WORKSPACE/$DIY_P1_SH"
            cd openwrt
            "$GITHUB_WORKSPACE/$DIY_P1_SH"
          fi
      - name: Update feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
      - name: Install feeds
        run: |
          cd openwrt
          ./scripts/feeds install -a
      - name: Load custom configuration
        run: |
          if [ -d files ]; then
            mv files openwrt/files
          fi

          if [ -f "$CONFIG_FILE" ]; then
            mv "$CONFIG_FILE" openwrt/.config
          fi

          if [ -f "$DIY_P2_SH" ]; then
            chmod +x "$DIY_P2_SH"
            cd openwrt
            "$GITHUB_WORKSPACE/$DIY_P2_SH"
          fi
      - name: Download packages
        run: |
          cd openwrt
          make defconfig
          make download -j$(nproc)
          find dl -size -1024c -delete
      - name: Compile firmware
        id: compile
        run: |
          cd openwrt
          make -j$(nproc) || make -j1 V=s
          grep '^CONFIG_TARGET.*DEVICE.*=y' .config | \
            sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME || true
          if [ -s DEVICE_NAME ]; then
            echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> "$GITHUB_ENV"
          fi
          echo "FILE_DATE=_$(date +%Y%m%d%H%M)" >> "$GITHUB_ENV"
          echo "status=success" >> "$GITHUB_OUTPUT"
      - name: Show disk usage
        if: '${{ !cancelled() }}'
        run: df -hT
      - name: Upload bin directory
        if: env.UPLOAD_BIN_DIR == 'true' && !cancelled()
        uses: actions/upload-artifact@v4
        with:
          name: 'OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}'
          path: openwrt/bin
      - name: Prepare firmware artifacts
        if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
        run: |
          cd openwrt/bin/targets/*/*
          rm -rf packages
          echo "FIRMWARE=$PWD" >> "$GITHUB_ENV"
      - name: Upload firmware
        if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
        uses: actions/upload-artifact@v4
        with:
          name: 'OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}'
          path: '${{ env.FIRMWARE }}'
      - name: Remove old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: '${{ secrets.GITHUB_TOKEN }}'
          retain_days: 1
          keep_minimum_runs: 1
      - name: Remove old releases
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        uses: dev-drprasad/delete-older-releases@v0.3.3
        with:
          keep_latest: '${{ env.KEEP_LATEST_RELEASES }}'
          delete_tags: true
          delete_prerelease_only: '${{ env.DELETE_ONLY_PRE_RELEASES }}'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
      - name: Final check
        if: steps.compile.outputs.status == 'success'
        run: |
          cd openwrt/bin/targets/*/*
          ls -lh
          echo "DEVICE_NAME=${{ env.DEVICE_NAME }}"
          echo "FILE_DATE=${{ env.FILE_DATE }}"
