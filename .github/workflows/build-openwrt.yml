---
name: 'Build OpenWrt'
'on':
  repository_dispatch: null
  workflow_dispatch:
    inputs:
      openwrt_version:
        default: '24.10.5'
        description: 'Specify OpenWrt version (e.g., 23.05.0 or 24.10.0-rc4)'
        required: false
env:
  REPO_URL: 'https://github.com/openwrt/openwrt.git'
  FEEDS_CONF: 'feeds.conf.default'
  CONFIG_FILE: '.config'
  DIY_P1_SH: 'diy-part1.sh'
  DIY_P2_SH: 'diy-part2.sh'
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: false
  TZ: 'Europe/Kiev'
  KEEP_LATEST_RELEASES: 3
  DELETE_ONLY_PRE_RELEASES: false
jobs:
  build:
    runs-on: 'ubuntu-24.04'
    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@v4'
      - name: 'Determine OpenWrt version'
        id: 'openwrt_version'
        run: "if [[ -n \"${{ github.event.inputs.openwrt_version }}\" ]]; then\n  echo \"Using manually specified OpenWrt version: ${{ github.event.inputs.openwrt_version }}\"\n  VERSION=\"v${{ github.event.inputs.openwrt_version }}\"\nelse\n  echo \"Fetching latest stable OpenWrt version...\"\n  VERSION=$(curl -s https://api.github.com/repos/openwrt/openwrt/releases | jq -r '[.[] | select(.prerelease == false)][0].tag_name')\n  if [ -z \"$VERSION\" ]; then\n    echo \"Failed to determine latest stable version. Defaulting to v23.05.0\"\n    VERSION=\"v23.05.0\"\n  fi\nfi\necho \"Using OpenWrt version: $VERSION\"\necho \"REPO_BRANCH=$VERSION\" >> $GITHUB_ENV\n"
      - name: 'Clone source code'
        run: "echo \"Cloning OpenWrt repository branch: ${{ env.REPO_BRANCH }}\"\ngit clone $REPO_URL -b $REPO_BRANCH --depth 1 openwrt\nif [ ! -d \"openwrt\" ]; then\n  echo \"Error: Failed to clone OpenWrt repository\"\n  exit 1\nfi\nln -sf $GITHUB_WORKSPACE/openwrt $GITHUB_WORKSPACE/openwrt\n"
      - name: 'Initialize environment'
        env:
          DEBIAN_FRONTEND: 'noninteractive'
        run: "sudo timedatectl set-timezone \"$TZ\"\nsudo mkdir -p /workdir\nsudo chown $USER:$GROUPS /workdir\n"
      - name: 'Clean up disk space'
        run: "sudo apt-get autoremove -y && sudo apt-get clean\nsudo rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*\nsudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL\nif command -v docker &> /dev/null; then\n  docker rmi $(docker image ls -aq) || true\nfi\ndf -h\n"
      - name: 'Load custom feeds'
        run: "[ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default\nchmod +x $DIY_P1_SH\ncd openwrt\n$GITHUB_WORKSPACE/$DIY_P1_SH\n"
      - name: 'Update feeds'
        run: 'cd openwrt && ./scripts/feeds update -a'
      - name: 'Install feeds'
        run: 'cd openwrt && ./scripts/feeds install -a'
      - name: 'Load custom configuration'
        run: "if [ -e \"files\" ]; then\n  echo \"Moving custom files\"\n  mv files openwrt/files\nelse\n  echo \"No custom files to move\"\nfi\nif [ -e \"$CONFIG_FILE\" ]; then\n  echo \"Moving custom config file\"\n  mv \"$CONFIG_FILE\" openwrt/.config\nelse\n  echo \"Custom config file not found, using default\"\nfi\nif [ -f \"$DIY_P2_SH\" ]; then\n  chmod +x \"$DIY_P2_SH\"\n  cd openwrt\n  $GITHUB_WORKSPACE/$DIY_P2_SH\nelse\n  echo \"Custom script $DIY_P2_SH not found, skipping\"\nfi\n"
      - name: 'Download package'
        id: 'package'
        run: "cd openwrt\nmake defconfig\nmake download -j$(nproc)\nfind dl -size -1024c -exec ls -l {} \\;\nfind dl -size -1024c -exec rm -f {} \\;\n"
      - name: 'Compile the firmware'
        id: 'compile'
        run: "cd openwrt\necho \"Compiling with $(nproc) threads\"\nmake -j$(nproc) || make -j1 V=s\necho \"status=success\" >> $GITHUB_OUTPUT\ngrep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\\1/' > DEVICE_NAME\n[ -s DEVICE_NAME ] && echo \"DEVICE_NAME=_$(cat DEVICE_NAME)\" >> $GITHUB_ENV\necho \"FILE_DATE=_$(date +\"%Y%m%d%H%M\")\" >> $GITHUB_ENV\n"
      - name: 'Check space usage'
        if: '(!cancelled())'
        run: 'df -hT'
      - name: 'Upload bin directory'
        uses: 'actions/upload-artifact@v4'
        if: 'env.UPLOAD_BIN_DIR == ''true'' && !cancelled()'
        with:
          name: 'OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}'
          path: 'openwrt/bin'
      - name: 'Organize files'
        id: 'organize'
        if: 'env.UPLOAD_FIRMWARE == ''true'' && !cancelled()'
        run: "cd openwrt/bin/targets/*/*\nrm -rf packages\necho \"FIRMWARE=$PWD\" >> $GITHUB_ENV\necho \"status=success\" >> $GITHUB_OUTPUT\n"
      - name: 'Upload firmware directory'
        uses: 'actions/upload-artifact@v4'
        if: 'env.UPLOAD_FIRMWARE == ''true'' && !cancelled()'
        with:
          name: 'OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}'
          path: '${{ env.FIRMWARE }}'
      - name: 'Get latest OpenWrt changes'
        id: 'openwrt_changes'
        run: "echo \"Fetching latest OpenWrt changes from GitHub API...\"\nchanges=$(curl -s 'https://api.github.com/repos/openwrt/openwrt/commits?sha=${{ env.REPO_BRANCH }}' | \n          jq -r '.[:10] | map(\"- \" + (.commit.author.date | .[0:10]) + \": \" + (.commit.message | split(\"\\n\")[0])) | .[]')\n\necho \"Debug: Latest OpenWrt changes:\"\necho \"$changes\"\n\nif [ -z \"$changes\" ]; then\n  echo \"Warning: No changes fetched. Using placeholder message.\"\n  changes=\"Unable to fetch recent changes. Please check the OpenWrt repository for updates.\"\nfi\n\necho \"formatted_changes<<EOF\" >> $GITHUB_OUTPUT\necho \"$changes\" >> $GITHUB_OUTPUT\necho \"EOF\" >> $GITHUB_OUTPUT\n"
      - name: 'Generate release tag'
        id: 'tag'
        if: 'env.UPLOAD_RELEASE == ''true'' && !cancelled()'
        run: "echo \"release_tag=${{ steps.openwrt_version.outputs.repo_branch }}-$(date +\"%Y.%m.%d\")${{ env.FILE_DATE }}\" >> $GITHUB_OUTPUT\necho \"status=success\" >> $GITHUB_OUTPUT\n"
      - name: 'Upload firmware to release'
        uses: 'softprops/action-gh-release@v2'
        if: 'env.UPLOAD_RELEASE == ''true'' && !cancelled()'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
        with:
          tag_name: '${{ steps.tag.outputs.release_tag }}'
          files: '${{ env.FIRMWARE }}/*'
          body: "This is an automated build of OpenWrt firmware for supported devices.\nBuilt on: ${{ steps.tag.outputs.release_tag }}\n\nDevice: ${{ env.DEVICE_NAME || 'Unknown' }}\n\n${{ env.FIRMWARE != '' && 'Firmware can be found in the assets below.' || 'No firmware files were generated.' }}\n\nRecent OpenWrt changes:\n${{ steps.openwrt_changes.outputs.formatted_changes || 'No recent changes information available.' }}\n"
      - name: 'Delete old workflow runs'
        uses: 'Mattraks/delete-workflow-runs@v2'
        with:
          token: '${{ secrets.GITHUB_TOKEN }}'
          repository: '${{ github.repository }}'
          retain_days: 1
          keep_minimum_runs: 1
          delete_workflow_pattern: 'build-openwrt.yml'
          delete_run_by_conclusion_pattern: 'success,failure,cancelled'
      - name: 'Remove old Releases'
        uses: 'dev-drprasad/delete-older-releases@v0.3.3'
        if: 'env.UPLOAD_RELEASE == ''true'' && !cancelled()'
        with:
          keep_latest: '${{ env.KEEP_LATEST_RELEASES }}'
          delete_tags: true
          delete_prerelease_only: '${{ env.DELETE_ONLY_PRE_RELEASES }}'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
      - name: 'Check compilation result'
        if: 'steps.compile.outputs.status == ''success'''
        run: "cd openwrt/bin/targets/*/*\necho \"=== Firmware files ===\"\nls -lh\necho \"======================\"\necho \"DEVICE_NAME: ${{ env.DEVICE_NAME }}\"\necho \"FILE_DATE: ${{ env.FILE_DATE }}\"\n"
      - name: 'Check environment'
        run: "echo \"Checking required tools...\"\nfor tool in git make gcc g++ unzip wget curl; do\n  if ! command -v $tool &> /dev/null; then\n    echo \"$tool is not installed. Please add it to the workflow.\"\n    exit 1\n  fi\ndone\necho \"All required tools are available.\"\n"
