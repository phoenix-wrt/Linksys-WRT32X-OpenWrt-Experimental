---
name: 'Build OpenWrt'
'on':
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: 'Specify OpenWrt version (e.g. 23.05.0 or 24.10.0-rc4)'
        default: '24.10.5'
        required: false
env:
  REPO_URL: 'https://github.com/openwrt/openwrt.git'
  FEEDS_CONF: 'feeds.conf.default'
  CONFIG_FILE: '.config'
  DIY_P1_SH: 'diy-part1.sh'
  DIY_P2_SH: 'diy-part2.sh'
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: false
  TZ: 'Europe/Kiev'
  KEEP_LATEST_RELEASES: 3
  DELETE_ONLY_PRE_RELEASES: false
jobs:
  build:
    runs-on: 'ubuntu-24.04'
    steps:
      - name: 'Checkout workflow repository'
        uses: 'actions/checkout@v4'
      - name: 'Determine OpenWrt version'
        id: 'version'
        run: "if [ -n \"${{ github.event.inputs.openwrt_version }}\" ]; then\n  RAW_VERSION=\"${{ github.event.inputs.openwrt_version }}\"\nelse\n  RAW_VERSION=$(curl -fsSL https://api.github.com/repos/openwrt/openwrt/releases | \\\n    jq -r '[.[] | select(.prerelease==false)][0].tag_name')\nfi\nVERSION=\"${RAW_VERSION#v}\"\nVERSION=\"v$VERSION\"\necho \"Using OpenWrt tag: $VERSION\"\necho \"REPO_BRANCH=$VERSION\" >> \"$GITHUB_ENV\"\n"
      - name: 'Initialize environment'
        env:
          DEBIAN_FRONTEND: 'noninteractive'
        run: "sudo timedatectl set-timezone \"$TZ\"\nsudo apt-get update\nsudo apt-get install -y \\\n  build-essential clang flex bison g++ gawk gcc-multilib \\\n  gettext git libncurses-dev libssl-dev python3-setuptools \\\n  rsync unzip zlib1g-dev file wget curl jq\n"
      - name: 'Clean up disk space'
        run: "sudo apt-get autoremove -y sudo apt-get clean sudo rm -rf /var/lib/apt/lists/* sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL df -h\n"
      - name: 'Clone OpenWrt source'
        run: "git clone \"$REPO_URL\" -b \"$REPO_BRANCH\" --depth 1 openwrt\ntest -d openwrt\n"
      - name: 'Load custom feeds'
        run: "if [ -f \"$GITHUB_WORKSPACE/$FEEDS_CONF\" ]; then\n  mv \"$GITHUB_WORKSPACE/$FEEDS_CONF\" openwrt/feeds.conf.default\nfi\nif [ -f \"$GITHUB_WORKSPACE/$DIY_P1_SH\" ]; then\n  chmod +x \"$GITHUB_WORKSPACE/$DIY_P1_SH\"\n  cd openwrt\n  \"$GITHUB_WORKSPACE/$DIY_P1_SH\"\nfi\n"
      - name: 'Force GitHub feeds mirrors'
        run: "cat > openwrt/feeds.conf.default <<'EOF'\nsrc-git packages https://github.com/openwrt/packages.git\nsrc-git luci https://github.com/openwrt/luci.git\nsrc-git routing https://github.com/openwrt/routing.git\nsrc-git telephony https://github.com/openwrt/telephony.git\nEOF\necho \"feeds.conf.default rewritten to use GitHub mirrors\"\ncat openwrt/feeds.conf.default\n"
      - name: 'Update feeds with retry & fallback'
        run: "cd openwrt\nfor i in 1 2 3; do\n  echo \"Feeds update attempt $i...\"\n  ./scripts/feeds update -a && break\n  sleep 10\ndone\nif [ $? -ne 0 ]; then\n  echo \"Feeds update failed after retries\"\n  exit 1\nfi\n"
      - name: 'Install feeds'
        run: "cd openwrt\n./scripts/feeds install -a\n"
      - name: 'Load custom configuration'
        run: "if [ -d files ]; then\n  mv files openwrt/files\nfi\nif [ -f \"$CONFIG_FILE\" ]; then\n  mv \"$CONFIG_FILE\" openwrt/.config\nfi\nif [ -f \"$DIY_P2_SH\" ]; then\n  chmod +x \"$DIY_P2_SH\"\n  cd openwrt\n  \"$GITHUB_WORKSPACE/$DIY_P2_SH\"\nfi\n"
      - name: 'Download packages'
        run: "cd openwrt\nmake defconfig\nmake download -j$(nproc)\nfind dl -size -1024c -delete\n"
      - name: 'Compile firmware'
        id: 'compile'
        run: "cd openwrt\nmake -j$(nproc) || make -j1 V=s\ngrep '^CONFIG_TARGET.*DEVICE.*=y' .config | \\\n  sed -r 's/.*DEVICE_(.*)=y/\\1/' > DEVICE_NAME || true\nif [ -s DEVICE_NAME ]; then\n  echo \"DEVICE_NAME=_$(cat DEVICE_NAME)\" >> \"$GITHUB_ENV\"\nfi\necho \"FILE_DATE=_$(date +%Y%m%d%H%M)\" >> \"$GITHUB_ENV\"\necho \"status=success\" >> \"$GITHUB_OUTPUT\"\n"
      - name: 'Show disk usage'
        if: '${{ !cancelled() }}'
        run: 'df -hT'
      - name: 'Upload bin directory'
        if: 'env.UPLOAD_BIN_DIR == ''true'' && !cancelled()'
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}'
          path: 'openwrt/bin'
      - name: 'Prepare firmware artifacts'
        if: 'env.UPLOAD_FIRMWARE == ''true'' && !cancelled()'
        run: "cd openwrt/bin/targets/*/*\nrm -rf packages\necho \"FIRMWARE=$PWD\" >> \"$GITHUB_ENV\"\n"
      - name: 'Upload firmware'
        if: 'env.UPLOAD_FIRMWARE == ''true'' && !cancelled()'
        uses: 'actions/upload-artifact@v4'
        with:
          name: 'OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}'
          path: '${{ env.FIRMWARE }}'
      - name: 'Cleanup old workflow runs (safe)'
        if: 'success()'
        continue-on-error: true
        uses: 'Mattraks/delete-workflow-runs@v2'
        with:
          token: '${{ secrets.GITHUB_TOKEN }}'
          retain_days: 3
          keep_minimum_runs: 2
      - name: 'Cleanup old releases (safe)'
        if: 'success() && env.UPLOAD_RELEASE == ''true'''
        continue-on-error: true
        uses: 'dev-drprasad/delete-older-releases@v0.3.3'
        with:
          keep_latest: '${{ env.KEEP_LATEST_RELEASES }}'
          delete_tags: true
          delete_prerelease_only: '${{ env.DELETE_ONLY_PRE_RELEASES }}'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
      - name: 'Final check'
        if: 'steps.compile.outputs.status == ''success'''
        run: "cd openwrt/bin/targets/*/*\nls -lh\necho \"DEVICE_NAME=${{ env.DEVICE_NAME }}\"\necho \"FILE_DATE=${{ env.FILE_DATE }}\"\n"
