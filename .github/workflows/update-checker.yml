name: Update Checker

env:
  REPO_URL: https://git.openwrt.org/openwrt/openwrt.git
  REPO_BRANCH: master

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *" # Каждый день в 00:00 по UTC

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Get Commit Hash
        id: getHash
        run: |
          retry() {
            local n=1
            local max=5
            local delay=5
            while true; do
              "$@" && break || {
                if [[ $n -lt $max ]]; then
                  ((n++))
                  echo "Retrying ($n/$max)..."
                  sleep $delay;
                else
                  echo "The command failed after $n attempts." >&2
                  return 1
                fi
              }
            done
          }

          retry git clone --depth 1 --branch $REPO_BRANCH --single-branch --filter=blob:none $REPO_URL .
          echo "::set-output name=commitHash::$(git rev-parse HEAD)"
          echo "::set-output name=commitDate::$(git show -s --format=%ci HEAD)"

      - name: Compare Commit Hash
        id: cacheHash
        uses: actions/cache@v3
        with:
          path: .commitHash
          key: HEAD-${{ steps.getHash.outputs.commitHash }}

      - name: Save New Commit Hash
        if: steps.cacheHash.outputs.cache-hit != 'true'
        run: |
          echo ${{ steps.getHash.outputs.commitHash }} | tee .commitHash
          echo ${{ steps.getHash.outputs.commitDate }} | tee .commitDate

      - name: Check for changes
        id: checkChanges
        run: |
          if [[ "${{ steps.cacheHash.outputs.cache-hit }}" == 'true' ]]; then
            echo "No changes detected. Exiting."
            exit 0
          fi

      - name: Trigger build
        if: steps.checkChanges.outcome == 'success'
        uses: peter-evans/repository-dispatch@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # Используем GITHUB_TOKEN для аутентификации
          event-type: Source Code Update

      - name: Delete workflow runs
        uses: GitRML/delete-workflow-runs@main
        with:
          retain_days: 1
          keep_minimum_runs: 1
